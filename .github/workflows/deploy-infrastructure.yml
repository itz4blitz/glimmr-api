name: ðŸš€ Deploy Infrastructure

on:
  push:
    branches: [main]
    paths: ['infrastructure/**']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  SERVER_HOST: 104.243.44.8
  SERVER_USER: blitz
  DEPLOY_PATH: /opt/glimmr

jobs:
  deploy:
    name: ðŸš€ Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: ðŸ” Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
          
      - name: ðŸŒ Setup DNS Records
        run: |
          echo "ðŸŒ Creating DNS records automatically..."

          # Create DNS records via Cloudflare API
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CF_API_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{"type":"A","name":"traefik.glimmr.health","content":"${{ env.SERVER_HOST }}","ttl":1}' || echo "DNS record may already exist"

          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CF_API_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{"type":"A","name":"auth.glimmr.health","content":"${{ env.SERVER_HOST }}","ttl":1}' || echo "DNS record may already exist"

          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
            -H "Authorization: Bearer ${{ secrets.CF_API_KEY }}" \
            -H "Content-Type: application/json" \
            --data '{"type":"A","name":"airbyte.glimmr.health","content":"${{ env.SERVER_HOST }}","ttl":1}' || echo "DNS record may already exist"

      - name: ðŸ“¦ Deploy Infrastructure
        run: |
          echo "ðŸš€ Starting deployment..."

          # Create directories on server
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p /opt/glimmr/{traefik,authentik,airbyte}"

          # Copy configurations to server
          scp -r infrastructure/traefik/* ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/opt/glimmr/traefik/
          scp -r infrastructure/authentik/* ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/opt/glimmr/authentik/
          scp -r infrastructure/airbyte/* ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/opt/glimmr/airbyte/

          # Auto-generate .env files
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'CF_API_KEY=${{ secrets.CF_API_KEY }}' > /opt/glimmr/traefik/.env"
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "cat > /opt/glimmr/airbyte/.env << 'EOF'
          # Airbyte version
          VERSION=0.50.33

          # Local storage paths
          LOCAL_ROOT=/tmp/airbyte_local
          HACK_LOCAL_ROOT_PARENT=/tmp

          # Basic auth for Airbyte UI
          BASIC_AUTH_USERNAME=airbyte
          BASIC_AUTH_PASSWORD=glimmr2024

          # Database configuration
          DATABASE_USER=docker
          DATABASE_PASSWORD=docker
          DATABASE_HOST=airbyte-db
          DATABASE_PORT=5432
          DATABASE_DB=airbyte

          # Configuration database
          CONFIG_DATABASE_USER=docker
          CONFIG_DATABASE_PASSWORD=docker
          CONFIG_DATABASE_URL=jdbc:postgresql://airbyte-db:5432/airbyte

          # Workspace and data directories
          WORKSPACE_ROOT=/tmp/workspace
          WORKSPACE_DOCKER_MOUNT=airbyte_workspace
          LOCAL_DOCKER_MOUNT=airbyte_local
          DATA_DOCKER_MOUNT=airbyte_data
          DB_DOCKER_MOUNT=airbyte_db

          # Airbyte URLs
          WEBAPP_URL=http://localhost:8000
          API_URL=http://localhost:8001
          INTERNAL_API_HOST=airbyte-server:8001

          # Worker configuration
          WORKER_ENVIRONMENT=docker
          EOF"

          # Create deployment script on server
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'cat > ~/deploy.sh << "EOF"
          #!/bin/bash
          set -e

          echo "ðŸš€ Starting deployment on server..."

          # Create networks if they don'\''t exist
          docker network create glimmr-frontend 2>/dev/null || echo "Network glimmr-frontend exists"
          docker network create glimmr-backend 2>/dev/null || echo "Network glimmr-backend exists"

          # Deploy services (only if .env files exist)
          cd /opt/glimmr

          if [ -f traefik/.env ]; then
            echo "ðŸ“Š Deploying Traefik..."
            cd traefik && docker compose up -d && cd ..
          else
            echo "âš ï¸  Skipping Traefik - no .env file"
          fi

          if [ -f authentik/.env ]; then
            echo "ðŸ” Deploying Authentik..."
            cd authentik && docker compose up -d && cd ..
          else
            echo "âš ï¸  Skipping Authentik - no .env file"
          fi

          if [ -f airbyte/.env ]; then
            echo "ðŸ“Š Deploying Airbyte..."
            cd airbyte && docker compose up -d && cd ..
          else
            echo "âš ï¸  Skipping Airbyte - no .env file"
          fi

          echo "âœ… Deployment complete!"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF'

          # Execute deployment script
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "chmod +x ~/deploy.sh && ~/deploy.sh"
          
      - name: ðŸ” Verify Deployment
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            echo 'ðŸ” Checking service status...'
            docker ps --filter 'name=traefik' --format 'table {{.Names}}\t{{.Status}}'
            docker ps --filter 'name=authentik' --format 'table {{.Names}}\t{{.Status}}'
            docker ps --filter 'name=airbyte' --format 'table {{.Names}}\t{{.Status}}'
          "
          
      - name: ðŸ“ Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure deployed to: \`${{ env.SERVER_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access Points:" >> $GITHUB_STEP_SUMMARY
          echo "- **Traefik Dashboard**: https://traefik.glimmr.health" >> $GITHUB_STEP_SUMMARY
          echo "- **Authentik**: https://auth.glimmr.health" >> $GITHUB_STEP_SUMMARY
          echo "- **Airbyte**: https://airbyte.glimmr.health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify services are running" >> $GITHUB_STEP_SUMMARY
          echo "2. Check SSL certificates" >> $GITHUB_STEP_SUMMARY
          echo "3. Test authentication flows" >> $GITHUB_STEP_SUMMARY
